---
title: "Precipitation Interpolation"
author: "Matthew Ross"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(sf) # new goodness
library(mapview)
library(lubridate)
library(osmdata)
library(gstat)
library(elevatr)
library(USAboundaries)
library(leafpop) #map html popup
library(stars)
library(viridis)
library(tmap) # make publication quality maps


knitr::opts_chunk$set(echo = TRUE)
```


# Load in Precip data

```{r, warning=F, message=F, results='hide'}
load('data/DailyP.RData')

daily_p %>% glimpse()
```


## Get Elevation Data

```{r, eval = T}
if(file.exists("data/unique_asos_elev.gpkg") == FALSE){
  unique_asos <- daily_p %>%
    distinct(lon, lat, station)  %>%
    st_as_sf(., coords = c('lon','lat'), crs = 4326) %>%
    get_elev_point(.)
  
  st_write(unique_asos, "data/unique_asos_elev.gpkg")
}
```

## Read elevation data
```{r, eval = TRUE}
unique_asos <- st_read("data/unique_asos_elev.gpkg")
```

## Get Monthly P Averages

```{r, warning=F, message=F, results='hide'}
monthly_p <- daily_p %>%
  mutate(month = month(date)) %>%
  group_by(month, station) %>%
  summarize(monthly_p = sum(daily_p)) %>%
  left_join(unique_asos, .) #grab elevation data
```


## Look at monthly P

```{r, warning=F, message=F, fig.width = 8, fig.height = 5}
ggplot(monthly_p, aes(x = elevation, y = monthly_p, color = month)) + 
  scale_color_viridis_c() + 
  geom_point()
```


## Getting Monthly Means of means, mins, maxes. 

```{r, warning=F, message=F, results='hide'}
monthly_t <- daily_p %>%
  mutate(month = month(date)) %>%
  group_by(month, station) %>%
  select(-lon,-lat) %>%
  summarize(across(where(is.numeric), mean, na.rm = T)) %>%
  left_join(unique_asos, .)
```


## Temp vs Elevation

```{r, warning=F, message=F, fig.width = 8, fig.height = 5}
ggplot(monthly_t, aes(y = mean_temp, x = elevation, color = month)) + 
  geom_point() + 
  scale_color_viridis_c()
```

### Set up CO state spatial

```{r, warning=F, message=F, results='hide'}
# get state polygon
co_state <- us_states(states = c("Colorado")) %>% 
  st_transform(2163)

# make grid out of state bounding box and crop to state
co_state_stars <- st_bbox(co_state) %>%
  st_as_stars(dx = 1000) %>% # 1km grid
  st_crop(co_state)

# change mapview defaults
mapviewOptions(homebutton = FALSE, basemaps = c("Esri"))
```

## Pick a month (summer months are safer)

```{r, warning=F, message=F, results='hide'}
my_idw_fn <- function(my_month = 7, response_v = "daily_p", predictor = 1, lab = "Mean Precipitation"){
# filter for month
  pushin_p <- monthly_t %>% 
    filter(month == my_month) %>% 
    mutate(across(where(is.numeric), ~ ifelse(is.infinite(.x), NA, .x)
                  )) %>% 
    filter(if_all(starts_with(response_v), ~ !is.na(.))) %>% # gets rid of Inf and NA so IDW works
    st_transform(2163)
# Build IDW
  fmla <- as.formula(paste(response_v, "~", predictor))
  idw_intrpltn <- idw(fmla, pushin_p, co_state_stars)
# Make plot
  idw_map <- mapview(idw_intrpltn
        , layer.name = lab
        , col.regions= mapviewGetOption('vector.palette')
        , popup = FALSE
  ) + mapview(pushin_p
        , zcol = response_v
        , legend = FALSE
  )
return(list(idw_map, idw_intrpltn))
}
```


```{r}
# unique_asos_t <- st_transform(unique_asos, crs = 2163)
# co_box <- st_bbox(unique_asos_t) %>% 
#   st_as_stars(dx=1000)
# 
# 
# july_t <- monthly_t %>% 
#   dplyr::filter(month == 7) %>% 
#   st_transform(., st_crs(co_box))
# 
# interp <- idw(mean_temp~1, july_t, co_box)
# 
# plot(interp)
# mapview(interp)
# 
# tm_shape(interp[1]) + tm_raster(palette = 'Reds', style = 'cont')
# 
# #elevation impacted model of temp
# ras <- get_elev_raster(unique_asos, z=8) %>% 
#   raster::crop(., unique_asos)
# 
# mapview(ras)
# co_stars <- st_as_stars(ras)
# 
# names(co_stars) <- 'elevation'
# 
# june_t <- monthly_t %>% 
#   filter(month == 6)
# 
# interp = gstat::idw(mean_temp~elevation, june_t, co_stars)
# 
# tm_shape(interp[1]) + tm_raster(palette = 'plasma', style='cont')
# 

```

### Build IDW precip or elevation for state for that month

```{r, warning=F, message=F, results='hide'}
precip_rslts <- my_idw_fn(my_month = 7, response_v = "mean_temp", predictor = 1, lab = "Aug Avg Precip")
maxt_rslts <- my_idw_fn(my_month = 8, response_v = "max_temp", predictor = 1, lab = "Aug Avg Max Temp (F)")
```

### Plot this data

```{r, warning=F, message=F, fig.width = 8, fig.height = 5}
# average precipitation IDW
# spatial interpolation only
precip_rslts[[1]]

# average max temp IDW
# spatial interpolation only
maxt_rslts[[1]]
```

### Build IDW with elevation for state for that month including elevation as a predictor

Hint! Use `get_elev_raster` use a z of 7 or 8

```{r, warning=F, message=F, results='hide'}
elev_raster <- get_elev_raster(co_state, z = 7)
names(elev_raster)[1] <- c("elevation")

co_state_stars <- elev_raster %>% 
  st_as_stars(., dx=4000, crs = 2163) %>% 
  st_crop(co_state)
```

### Make a Map of that

```{r, warning=F, message=F, fig.width = 8, fig.height = 5}
## You will need to create a Stars raster that has elevation data. 
precip_elev <- my_idw_fn(my_month = 8, response_v = "max_temp", predictor = "elevation", lab = "Aug. Max Temp")
precip_elev[[1]]

```


### Compare both maps to PRISM approach for your month


How close do our simple approaches come to reproducing prism maps? 


https://www.prism.oregonstate.edu/recent/monthly.php


```{r, warning=F, message=F, fig.width = 8, fig.height = 5}

```

