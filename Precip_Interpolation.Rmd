---
title: "Precipitation Interpolation"
author: "Matthew Ross"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(sf) # new goodness
library(mapview)
library(lubridate)
library(osmdata)
library(gstat)
library(elevatr)
library(USAboundaries)
library(leafpop) #map html popup
library(stars)


knitr::opts_chunk$set(echo = TRUE)
```


# Load in Precip data

```{r, warning=F, message=F, results='hide'}
load('data/DailyP.RData')

daily_p %>% glimpse()
```


## Get Elevation Data

```{r, eval = F}
unique_asos <- daily_p %>%
  distinct(lon, lat, station)  %>%
  st_as_sf(., coords = c('lon','lat'), crs = 4326) %>%
  get_elev_point(.)

st_write(unique_asos, 'data/unique_asso_elev.gpkg')
```

## Get Monthly P Averages


```{r, warning=F, message=F, results='hide'}
monthly_p <- daily_p %>%
  mutate(month = month(date)) %>%
  group_by(month, station) %>%
  summarize(monthly_p = sum(daily_p)) %>%
  left_join(unique_asos, .) #grab elevation data
  

```


## Look at monthly P

```{r, warning=F, message=F, fig.width = 8, fig.height = 5}
ggplot(monthly_p, aes(x = elevation, y = monthly_p, color = month)) + 
  scale_color_viridis_c() + 
  geom_point()
```


## Getting Monthly Means of means, mins, maxes. 

```{r, warning=F, message=F, results='hide'}
monthly_t <- daily_p %>%
  mutate(month = month(date)) %>%
  group_by(month, station) %>%
  select(-lon,-lat) %>%
  summarize(across(where(is.numeric), mean)) %>%
  left_join(unique_asos, .)
```


## Temp vs Elevation


```{r, warning=F, message=F, fig.width = 8, fig.height = 5}
ggplot(monthly_t, aes(y = mean_temp, x = elevation, color = month)) + 
  geom_point() + 
  scale_color_viridis_c()
```



## Pick a month (summer months are safer)

```{r, warning=F, message=F, results='hide'}
pushin_p <- monthly_t %>% 
  filter(month == 7) %>% 
  st_transform(2163)
```

### Build IDW precip or elevation for state for that month

```{r, warning=F, message=F, results='hide'}
co_state <- us_states(states = c("Colorado")) %>% 
  st_transform(2163)

pushin_p_stars <- st_bbox(co_state) %>%
  st_as_stars(dx = 1000) %>%
  st_crop(co_state)
  
interp = idw(daily_p~1, pushin_p, pushin_p_stars)
```

### Plot this data

```{r, warning=F, message=F, fig.width = 8, fig.height = 5}

mapview(interp,na.col=NA,col.regions=mapviewGetOption('vector.palette')) + 
  mapview(pushin_p, zcol = 'daily_p')


```

### Build IDW with elevation for state for that month including elevation as a predictor

Hint! Use `get_elev_raster` use a z of 7 or 8

```{r, warning=F, message=F, results='hide'}

```

### Make a Map of that

```{r, warning=F, message=F, fig.width = 8, fig.height = 5}
## You will need to create a Stars raster that has elevation data. 



```


### Compare both maps to PRISM approach for your month


How close do our simple approaches come to reproducing prism maps? 


https://www.prism.oregonstate.edu/recent/monthly.php


```{r, warning=F, message=F, fig.width = 8, fig.height = 5}

```

